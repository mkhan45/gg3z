<!DOCTYPE html>
<html>
    <head>
        <title> editor </title>
    </head>
    <body>
        <textarea id="input" style="width: 80vw; height: 30em">
Begin Facts:
    position(player, 0, 0)
End Facts

Begin Global:
End Global

Begin Stage Move:
End Stage Move
        </textarea>
        <br/>
        <button id="reload">Reload</button>
        <span id="stages"></span>
        <br/>
        <input id="query-input" type="text" placeholder="position(player, X, Y)" style="width: 300px"/>
        <button id="query-btn">Query</button>
        <br/>
        <pre id="output"></pre>
        <script type="module">
            import module_loader from './langame.js';

            const Module = await module_loader({});
            window.Module = Module;

            let parse_module = Module.cwrap('parse_module', 'number', ['string']);
            window.parse_module = parse_module;

            let module_to_string = Module.cwrap('module_to_string', 'string', ['number']);
            window.module_to_string = module_to_string;

            let free_module = Module.cwrap('free_module', null, ['number']);
            window.free_module = free_module;

            let create_game_state = Module.cwrap('create_game_state', 'number', []);
            let game_state_reset = Module.cwrap('game_state_reset', null, ['number']);
            let game_state_load_facts = Module.cwrap('game_state_load_facts', null, ['number', 'number']);
            let game_state_load_global = Module.cwrap('game_state_load_global', null, ['number', 'number']);
            let game_state_load_stage = Module.cwrap('game_state_load_stage', null, ['number', 'number', 'number']);
            let game_state_check = Module.cwrap('game_state_check', 'number', ['number']);
            let module_stage_count = Module.cwrap('module_stage_count', 'number', ['number']);
            let module_get_stage_name = Module.cwrap('module_get_stage_name', 'string', ['number', 'number']);
            let game_state_query = Module.cwrap('game_state_query', 'string', ['number', 'string']);

            const reloadBtn = document.querySelector('#reload');
            const stagesSpan = document.querySelector('#stages');
            const inp = document.querySelector('#input');
            const out = document.querySelector('#output');
            const queryInput = document.querySelector('#query-input');
            const queryBtn = document.querySelector('#query-btn');

            let gameState = create_game_state();
            let currentModule = null;

            const SAT_RESULTS = ['Sat', 'Unsat', 'Unknown'];

            function buildStageButtons() {
                stagesSpan.innerHTML = '';
                if (!currentModule) return;
                const count = module_stage_count(currentModule);
                for (let i = 0; i < count; i++) {
                    const btn = document.createElement('button');
                    btn.textContent = module_get_stage_name(currentModule, i);
                    btn.onclick = () => {
                        game_state_load_stage(gameState, currentModule, i);
                        const result = game_state_check(gameState);
                        out.innerText += '\nLoaded stage: ' + btn.textContent + ' -> ' + SAT_RESULTS[result];
                    };
                    stagesSpan.appendChild(btn);
                }
            }

            reloadBtn.onclick = () => {
                game_state_reset(gameState);
                
                if (currentModule) {
                    free_module(currentModule);
                }

                const code = inp.value;
                currentModule = parse_module(code);
                
                if (!currentModule) {
                    out.innerText = 'Parse error';
                    return;
                }

                game_state_load_facts(gameState, currentModule);
                game_state_load_global(gameState, currentModule);
                
                const result = game_state_check(gameState);
                out.innerText = module_to_string(currentModule) + '\n\nCheck: ' + SAT_RESULTS[result];
                
                buildStageButtons();
            };

            queryBtn.onclick = () => {
                const queryStr = queryInput.value;
                if (!queryStr) return;
                const result = game_state_query(gameState, queryStr);
                out.innerText += '\n\nQuery: ' + queryStr + '\n' + result;
            };
        </script>
    </body>
</html>
